# algo| 业务: 快递状态轮询

想想可以写一个 `业务上的算法趣题系列`, 业务虽然多数时候是流程复杂, 但是有一些小的点可以感受到 `算法的乐趣`, 会带来很不一样的感受

业务上的算法趣题系列:
- [tech| 关于电商系统中sku与spu的一个难题](https://www.jianshu.com/p/edc5b28e2842)

## 场景

想到一个算法题，需要轮询物流的状态，现在的策略比较简单，每 2 小时查询 4 个小时内物流状态没有更新的订单.

这个策略会导致2个问题：
- 时间越久的订单，应该优先级越高，因为物流状态更新的可能性越大
- 2 小时间隔可能产生波峰,  某段时间需要论询的订单量太大，导致性能跟不上, 现在平均每小时要查 50w 单

希望算法实现的效果：
- 时间越久的订单，优先级越高
- 论询能尽量平滑，不会导致一个时间堆积太多

- 异常物流单(假单) 3天无状态->异常

## 提炼成常见算法题的描述

快递记录的数据结构:
- 订单号 oid (order id)
- 物流单号 lid (logistic id)
- 物流类型 type: 不同物流类型对应不同第三方服务
- 物流状态 status
- 物流信息 msg: 物流信息的更新频次比 status 高
- 物流时间 -> 处理异常订单的查询
- 物流单生成时间 ct (created time)
- 物流单更新时间 ut (updated time)
- 物流单上次查询时间 qt (query time)
- 物流单上次状态变更时间 st(status time)

数据规律:
- qt aes, ct aes: 优先级最高, 业务语言就是物流状态变化的可能性更大
- 固定时间段内物流单数不固定, 也就是说有波峰也有波谷

算法流程
- 定时任务扫需要查询物流的订单 -> 协程查询第三方快递服务

- 队列满, 等待下一次定时任务, 防止未执行的完的任务重复入队列
- 队列空, 按照优先级入队
- 消费者消费

算法优化:
- 消费者根据队列情况动态扩缩容

## 工程化考量

- 如果工程化考虑, 代码中的业务逻辑完全不改, 轮询时间间隔调短/多开进程/加机器, 完全也能「抗」得住. 
- A/B 策略, 如何切流量, 达到新老服务平稳过渡以及对比
- 核心指标监控: 类似 [性能测试PTS](https://help.aliyun.com/product/29260.html) 中建立的 SLA(服务等级协议) 来设置监控项
    - SLA 指标
        - RT(response time, 响应时间): 时间段内需要处理的物流单数
        - PRS(request per second, 每秒请求量): 时间段内处理的物流单数
        - 成功率: 时间段内查询后更新了状态的物流单数 / 时间段内处理的物流单数
        - 75% 响应时间: 75%以内的状态未更新的订单数, 状态未更新时间需要在设置「响应时间」内 
    - SLA 规则: 在 SLA 指标基础上添加条件判断, 触发告警

## 写在最后

但是算法, 就是解决问题时的那份「优雅」.